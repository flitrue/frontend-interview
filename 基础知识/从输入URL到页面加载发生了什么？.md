# 从输入URL到页面加载发生了什么？

## 简洁版：

- 浏览器根据请求的URL交给DNS域名解析，找到真实的IP，向服务器发起请求；
- 服务器交给后台处理完成后返回数据，浏览器接收文件（HTML、CSS、JavaScript等）；
- 浏览器对加载到的资源（HTML、CSS、JavaScript等）进行语法解析，构建相应的内部数据结构（DOM树、CSS树、render树等）；
- 载入解析到的资源文件、渲染页面、完成。

## 详细版：

- 首先浏览器开启一个线程来处理这个请求，对URL分析判断，如果是http协议就按照Web方式来处理；
- 其次浏览器会对URL进行解析，一般包括（协议头、主机域名或IP地址、端口号、请求路径、查询参数、hash等），然后开启网络线程发出一个完整到http请求；
- 当然一般我们输入的URL是服务器域名，这时就需要DNS通过域名查询得到对应的IP；
- DNS首先会查看浏览器DNS缓存，没有就查询计算机本地DNS缓存，还没有就询问递归式DNS服务器（即网络提供商，一般这个服务器都会有自己的缓存，所以IP查询一般在这里完成），如果没有缓存，那就需要通过根域名和TLD域名服务器指到对应的权威DNS服务器找回记录，并缓存到递归式服务器，然后递归服务器在将记录返回给本地。
- 有了IP地址，此时网络层便会通过IP地址寻的对应服务器的物理地址
- 寻得服务器地址，客户端在网络传输层便可以和服务器通过三次握手建立tcpip连接
- 连接建立后网络数据链路层将数据包装成帧；
- 最后物理层利用物理介质进行传输；
- 到了服务器，就会通过相反的方式将数据一层一层的还原回去；
- 请求到了后台服务器，一般会有统一的验证，如安全验证、跨域验证等，验证未通过就直接返回相应的http报文
- 验证通过后，就会进入后台代码，此时程序收到请求，然后执行对应的操作（如查询数据库等）；
- 如果浏览器访问过，且缓存上有对应的资源，便会与服务器最后修改时间对比，一致便返回304，告诉浏览器可使用本地缓存；
- 前端浏览器接收到响应成功的报文后便开始下载网页
- 下载完的网页将被交给浏览器内核（渲染进程）进行处理：

 1. 根据顶部定义的DTD类型进行对应的解析方式；
 1. 渲染进程内部是多线程的，网页的解析将会被交给内部的GUI渲染线程处理；
 1. 首先渲染线程中的HTML解释器，将HTML网页和资源从字节流解释转换成字符流；
 1. 再通过词法分析器将字符流解释成词语；
 1. 之后经过语法分析器根据词语构建成节点；最后通过这些节点组建一个DOM树；
 1. 这个过程中，如果遇到的DOM节点是JavaScript代码，就会调用JavaScript引擎对JavaScript代码进行解释执行，此时由JavaScript引擎和GUI渲染线程的互斥，GUI渲染线程就会被挂起，渲染过程停止；如果JavaScript代码的运行中对DOM树进行了修改，那么DOM的构建需要从新开始；
 1. 如果节点需要依赖其他资源，如（图片，CSS等），便会调用网络模块的资源加载器来加载它们，但它们是异步的，不会阻塞当前DOM树的构建；
 1. 如果遇到的是JavaScript资源URL（没有标记异步），则需要停止当前DOM的构建，直到JavaScript的资源加载并被JavaScript引擎执行后才继续构建DOM；
 1. 对于CSS，CSS解释器会将CSS文件解释成内部表示结构，生成CSS规则树；
 1. 然后合并CSS规则树和DOM树，生成render渲染树；
 1. 最后对render树进行布局和绘制，并将结果通过IO线程传递给Browser控制进程进行显示。
 
 [参考链接：https://segmentfault.com/a/1190000014872028](https://segmentfault.com/a/1190000014872028)
